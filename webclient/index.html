<!DOCTYPE html>
<html lang="en-US">

<head>
    <title>Remote Desktop</title>

    <style>
        body {
            margin: 0;
            padding: 0;
        }

        img {
            float: left;

            position: relative;
            transform: translate(0px, 25%);
        }
    </style>
</head>

<body>
    <script src="/Packet.js"></script>
    <script>
        const server = new WebSocket("{origin}/")

        server.addEventListener("open", event => {
            console.log("Connection opened")
        })

        server.addEventListener("message", event => {
            var message = Packet.decode(event.data)

            window.addEventListener("mousedown", event => {
                if (event.target.id.includes("display")) {
                    event.stopImmediatePropagation()
                    event.preventDefault()

                    if (event.button == 0) var button = "left"
                    else if (event.button == 1) var button = "middle"
                    else if (event.button == 2) var button = "right"

                    server.send(new Packet("mouseclick", { button }).encode())
                }
            })

            window.addEventListener("contextmenu", event => {
                if (event.target.id.includes("display")) {
                    event.stopImmediatePropagation()
                    event.preventDefault()
                }
            })

            window.addEventListener("mousemove", () => {

            })

            window.addEventListener("keydown", event => {
                event.stopImmediatePropagation()
                event.preventDefault()

                var keys = {
                    // A-Z
                    "KeyA": "a",
                    "KeyB": "b",
                    "KeyC": "c",
                    "KeyD": "d",
                    "KeyE": "e",
                    "KeyF": "f",
                    "KeyG": "g",
                    "KeyH": "h",
                    "KeyI": "i",
                    "KeyJ": "j",
                    "KeyK": "k",
                    "KeyL": "l",
                    "KeyM": "m",
                    "KeyN": "n",
                    "KeyO": "o",
                    "KeyP": "p",
                    "KeyQ": "q",
                    "KeyR": "r",
                    "KeyS": "s",
                    "KeyT": "t",
                    "KeyU": "u",
                    "KeyV": "v",
                    "KeyW": "w",
                    "KeyX": "x",
                    "KeyY": "y",
                    "KeyZ": "z",

                    // 0-9
                    "Digit0": "0",
                    "Digit1": "1",
                    "Digit2": "2",
                    "Digit3": "3",
                    "Digit4": "4",
                    "Digit5": "5",
                    "Digit6": "6",
                    "Digit7": "7",
                    "Digit8": "8",
                    "Digit9": "9",

                    // Special charecters
                    "Backquote": "`",
                    "Minus": "-",
                    "Equal": "-",
                    "BracketLeft": "[",
                    "BracketRight": "]",
                    "Backslash": "\\",
                    "Semicolon": ";",
                    "Quote": "'",
                    "Comma": ",",
                    "Period": ".",
                    "Slash": "/",

                    // Special keys
                    "Space": "space",
                    "Backspace": "backspace",
                    "Enter": "enter",
                    "Tab": "tab",

                    // Functional keys
                    "PrintScreen": "printscreen",
                    "Insert": "insert",
                    "Delete": "delete",
                    "Home": "home",
                    "End": "end",
                    "PageUp": "pageup",
                    "PageDown": "pagedown",
                    "Escape": "escape",

                    // Arrow keys
                    "ArrowUp": "up",
                    "ArrowDown": "down",
                    "ArrowLeft": "left",
                    "ArrowRight": "right",

                    // Function keys
                    "F1": "f1",
                    "F2": "f2",
                    "F3": "f3",
                    "F4": "f4",
                    "F5": "f5",
                    "F6": "f6",
                    "F7": "f7",
                    "F8": "f8",
                    "F9": "f9",
                    "F10": "f10",
                    "F11": "f11",
                    "F12": "f12",

                    // Modifier keys
                    "Command": "command",
                    "MetaLeft": "command",
                    "MetaRight": "command",
                    "AltLeft": "alt",
                    "AltRight": "alt",
                    "ControlLeft": "control",
                    "ControlRight": "control",
                    "ShiftLeft": "shift",
                    "ShiftRight": "right_shift",

                    // Control keys
                    "AudioVolumeMute": "audio_mute",
                    "AudioVolumeDown": "audio_vol_down",
                    "AudioVolumeUp": "audio_vol_up",
                    "MediaTrackPrevious": "audio_prev",
                    "MediaPlayPause": "audio_pause",
                    "MediaTrackNext": "audio_next",

                    // Numpad keys
                    "Numpad0": "numpad_0",
                    "Numpad1": "numpad_1",
                    "Numpad2": "numpad_2",
                    "Numpad3": "numpad_3",
                    "Numpad4": "numpad_4",
                    "Numpad5": "numpad_5",
                    "Numpad6": "numpad_6",
                    "Numpad7": "numpad_7",
                    "Numpad8": "numpad_8",
                    "Numpad9": "numpad_9",
                    "NumpadAdd": "+",
                    "NumpadSubtract": "-",
                    "NumpadMultiply": "*",
                    "NumpadDivide": "/",
                    "NumpadDecimal": ".",
                    "NumpadEnter": "enter"
                }

                var type = false
                var key = keys[event.code]
                if (key == undefined) return console.warn("Unknown Key " + event.code)

                var modifiers = []
                if (event.shiftKey) modifiers.push("shift")
                if (event.ctrlKey) modifiers.push("control")
                if (event.altKey) modifiers.push("alt")
                else if (event.metaKey) modifiers.push("command")

                server.send(new Packet("keypress", { key, modifiers, type: false }).encode())
            })

            if (message.type == "display") {
                if (document.getElementById("display" + message.data.id) != null) {
                    document.getElementById("display" + message.data.id).src = URL.createObjectURL(new Blob([new Uint8Array(message.data.image.data)], { type: 'image/jpg' }))

                    var amount = 0

                    for (var running = true, index = 0; running; index++) {
                        if (document.getElementById("display" + index) != null) {
                            amount++
                        } else running = false
                    }

                    document.getElementById("display" + message.data.id).width = window.innerWidth / amount
                } else {
                    var image = document.createElement("img")
                    image.id = "display" + message.data.id
                    image.src = URL.createObjectURL(new Blob([new Uint8Array(message.data.image.data)], { type: 'image/jpg' }))
                    document.body.appendChild(image)
                }
            }
        })

        server.addEventListener("close", event => {
            console.log("Connection closed")
        })
    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="en-US">

<head>
    <title>Remote Desktop</title>

    <style>
        body {
            margin: 0;
            padding: 0;
        }

        img {
            float: left;
        }
    </style>
</head>

<body>
    <div id="displays"></div>

    <script src="/Packet.js"></script>
    <script>
        const fps = parseInt(localStorage.getItem("fps") || 5)
        const fixedFps = (localStorage.getItem("fixedFps") || "false") == "true" ? true : false

        const scale = parseFloat(localStorage.getItem("scale") || 0.50)
        const quality = parseInt(localStorage.getItem("quality") || 50)

        const pps = parseInt(localStorage.getItem("pps") || 2)
        const fixedPps = (localStorage.getItem("fixedPps") || "true") == "true" ? true : false

        localStorage.setItem("fps", fps)
        localStorage.setItem("fixedFps", fixedFps)

        localStorage.setItem("scale", scale)
        localStorage.setItem("quality", quality)

        localStorage.setItem("pps", pps)
        localStorage.setItem("fixedPps", fixedPps)

        const toSend = []

        document.addEventListener("mousedown", event => {
            if (event.target.id.includes("display")) {
                event.stopImmediatePropagation()
                event.preventDefault()

                if (event.button == 0) var button = "left"
                else if (event.button == 1) var button = "middle"
                else if (event.button == 2) var button = "right"

                quePacket({ url: "/control", data: new Packet("mouseclick", { button }).encode() })
            }
        })

        document.addEventListener("contextmenu", event => {
            if (event.target.id.includes("display")) {
                event.stopImmediatePropagation()
                event.preventDefault()
            }
        })

        var prevPos = { x: 0, y: 0 }

        document.addEventListener("mousemove", event => {
            if (event.target.id.includes("display")) {
                var pos = { x: event.pageX - event.target.x, y: event.pageY - event.target.y }

                pos.x = pos.x / (event.target.width / JSON.parse(event.target.getAttribute("displayAttributes")).width)
                pos.y = pos.y / (event.target.height / JSON.parse(event.target.getAttribute("displayAttributes")).height)

                if (prevPos == pos) return
                else prevPos = pos

                quePacket({ url: "/control", data: new Packet("mousemove", { x: pos.x, y: pos.y }).encode() })
            }
        })

        document.addEventListener("wheel", event => {
            if (event.target.id.includes("display")) {
                quePacket({ url: "/control", data: new Packet("mousescroll", { x: event.deltaX, y: event.deltaY }).encode() })
            }
        })

        document.addEventListener("keydown", event => {
            event.stopImmediatePropagation()
            event.preventDefault()

            var keys = {
                // A-Z
                "KeyA": "a",
                "KeyB": "b",
                "KeyC": "c",
                "KeyD": "d",
                "KeyE": "e",
                "KeyF": "f",
                "KeyG": "g",
                "KeyH": "h",
                "KeyI": "i",
                "KeyJ": "j",
                "KeyK": "k",
                "KeyL": "l",
                "KeyM": "m",
                "KeyN": "n",
                "KeyO": "o",
                "KeyP": "p",
                "KeyQ": "q",
                "KeyR": "r",
                "KeyS": "s",
                "KeyT": "t",
                "KeyU": "u",
                "KeyV": "v",
                "KeyW": "w",
                "KeyX": "x",
                "KeyY": "y",
                "KeyZ": "z",

                // 0-9
                "Digit0": "0",
                "Digit1": "1",
                "Digit2": "2",
                "Digit3": "3",
                "Digit4": "4",
                "Digit5": "5",
                "Digit6": "6",
                "Digit7": "7",
                "Digit8": "8",
                "Digit9": "9",

                // Special charecters
                "Backquote": "`",
                "Minus": "-",
                "Equal": "-",
                "BracketLeft": "[",
                "BracketRight": "]",
                "Backslash": "\\",
                "Semicolon": ";",
                "Quote": "'",
                "Comma": ",",
                "Period": ".",
                "Slash": "/",

                // Special keys
                "Space": "space",
                "Backspace": "backspace",
                "Enter": "enter",
                "Tab": "tab",

                // Functional keys
                "PrintScreen": "printscreen",
                "Insert": "insert",
                "Delete": "delete",
                "Home": "home",
                "End": "end",
                "PageUp": "pageup",
                "PageDown": "pagedown",
                "Escape": "escape",

                // Arrow keys
                "ArrowUp": "up",
                "ArrowDown": "down",
                "ArrowLeft": "left",
                "ArrowRight": "right",

                // Function keys
                "F1": "f1",
                "F2": "f2",
                "F3": "f3",
                "F4": "f4",
                "F5": "f5",
                "F6": "f6",
                "F7": "f7",
                "F8": "f8",
                "F9": "f9",
                "F10": "f10",
                "F11": "f11",
                "F12": "f12",

                // Modifier keys
                "Command": "command",
                "MetaLeft": "command",
                "MetaRight": "command",
                "AltLeft": "alt",
                "AltRight": "alt",
                "ControlLeft": "control",
                "ControlRight": "control",
                "ShiftLeft": "shift",
                "ShiftRight": "right_shift",

                // Control keys
                "AudioVolumeMute": "audio_mute",
                "AudioVolumeDown": "audio_vol_down",
                "AudioVolumeUp": "audio_vol_up",
                "MediaTrackPrevious": "audio_prev",
                "MediaPlayPause": "audio_pause",
                "MediaTrackNext": "audio_next",

                // Numpad keys
                "Numpad0": "numpad_0",
                "Numpad1": "numpad_1",
                "Numpad2": "numpad_2",
                "Numpad3": "numpad_3",
                "Numpad4": "numpad_4",
                "Numpad5": "numpad_5",
                "Numpad6": "numpad_6",
                "Numpad7": "numpad_7",
                "Numpad8": "numpad_8",
                "Numpad9": "numpad_9",
                "NumpadAdd": "+",
                "NumpadSubtract": "-",
                "NumpadMultiply": "*",
                "NumpadDivide": "/",
                "NumpadDecimal": ".",
                "NumpadEnter": "enter"
            }

            var type = false
            var key = keys[event.code]
            if (key == undefined) return console.warn("Unknown Key " + event.code)

            var modifiers = []
            if (event.shiftKey) modifiers.push("shift")
            if (event.ctrlKey) modifiers.push("control")
            if (event.altKey) modifiers.push("alt")
            else if (event.metaKey) modifiers.push("command")

            quePacket({ url: "/control", data: new Packet("keypress", { key, modifiers, type: false }).encode() })
        })

        fetch("/displays").then(res => res.text()).then(data => {
            var message = Packet.decode(data)

            message.data.forEach(display => {
                if (document.getElementById("display" + display.id) == null) {
                    var image = document.createElement("img")
                    image.id = "display" + display.id
                    image.width = window.innerWidth / message.data.length
                    image.setAttribute("displayAttributes", JSON.stringify({ id: display.id, width: display.size.width, height: display.size.height }))
                    document.getElementById("displays").appendChild(image)

                    if (fixedFps) {
                        setInterval(() => {
                            fetch("/display", {
                                headers: {
                                    packet: new Packet("display", { id: display.id, scale, quality }).encode()
                                }
                            }).then(res => res.text()).then(data => {
                                var message = Packet.decode(data)

                                if (message.data.status == "change") image.src = URL.createObjectURL(new Blob([new Uint8Array(message.data.image.data)], { type: "image/webp" }))
                            })
                        }, 1000 / fps)
                    } else {
                        function getScreen() {
                            fetch("/display", {
                                headers: {
                                    packet: new Packet("display", { id: display.id, scale, quality }).encode()
                                }
                            }).then(res => res.text()).then(data => {
                                var message = Packet.decode(data)

                                if (message.data.status == "change") image.src = URL.createObjectURL(new Blob([new Uint8Array(message.data.image.data)], { type: "image/webp" }))

                                getScreen()
                            })
                        }
                        getScreen()
                    }
                }
            })
        })

        function quePacket(packet) {
            toSend.forEach(packet2 => {
                if (packet.data.type == packet2.data.type) toSend.splice(toSend.indexOf(packet2), 1)
            })

            toSend.push(packet)
        }

        if (fixedPps) {
            setInterval(() => {
                if (toSend.length == 0) return

                fetch(toSend[0].url, {
                    headers: {
                        packet: toSend[0].data
                    }
                }).then(res => res.text()).then(data => {
                    toSend.splice(0, 1)
                })
            }, 1000 / pps)
        } else {
            function sendPackets() {
                if (toSend.length == 0) requestAnimationFrame(sendPackets)
                else {
                    fetch(toSend[0].url, {
                        headers: {
                            packet: toSend[0].data
                        }
                    }).then(res => res.text()).then(data => {
                        toSend.splice(0, 1)

                        sendPackets()
                    })
                }
            }
            sendPackets()
        }
    </script>
</body>

</html>